!function(e){function t(n){if(o[n])return o[n].exports;var r=o[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t){function o(e){e&&e.systems.building&&e.systems.building.reexamineBuilding()}function n(e){"position"==e.detail.name&&o(e.detail.target.sceneEl)}function r(){this.lastScene=this.el.sceneEl,o(this.lastScene),this.el.addEventListener("componentchanged",n)}function a(){o(this.lastScene)}function i(){o(this.lastScene),this.lastScene=null,this.el.removeEventListener("componentchanged",n)}AFRAME.registerSystem("building",{reexamineBuilding:function(){function e(e){for(var t=0;t<e.faces.length;t++){var o=e.faces[t],n=o.c;o.c=o.b,o.b=n}}function t(e,t){for(var o=["a","b","c"],n=0;n<e.faces.length;n++){var r=e.faces[n];e.faceVertexUvs[0][n]||(e.faceVertexUvs[0][n]=[]);for(var a=e.faceVertexUvs[0][n],i=0;i<o.length;i++){var s=r[o[i]],l=e.vertices[s];a[i]||(a[i]=new THREE.Vector2);var m=a[i];t(l,m,s)}}e.uvsNeedUpdate=!0}function o(e,o,n,r,a){t(e,function(e,t){t.set(e[o]*r,e[n]*a)})}function n(e){e.computeFaceNormals(),e.computeVertexNormals(),e.computeBoundingBox(),e.computeBoundingSphere()}function r(e){for(var t=e.components.room.data.outside,o=[],n=0;n<e.children.length;n++){var r=e.children[n];r.components.wall&&o.push(r)}for(var a=0,i=0;i<o.length;i++){var s=o[i],l=o[(i+1)%o.length],m=s.components.position.data,c=l.components.position.data;a+=(c.x-m.x)*(c.z+m.z)}var p=!1;return a>0&&(p=!p),t&&(p=!p),p&&o.reverse(),o}function a(e){var t=r(e.parentNode),o=t.indexOf(e);return t[(o+1)%t.length]}function i(e,t){var o=e.parentNode,n=a(o);if(n){var r=o.object3D.getWorldPosition(),i=n.object3D.getWorldPosition(),s=t.object3D.getWorldPosition(),l=s.x-r.x,c=s.z-r.z,p=i.x-r.x,d=i.z-r.z,h=Math.atan2(d,p),f=Math.sqrt(p*p+d*d),g=l*Math.cos(-h)-c*Math.sin(-h),v=t.components.doorlink.data.width/2;g=Math.max(g,v+m),g=Math.min(g,f-v-m),e.setAttribute("position",{x:g,y:0,z:0}),e.object3D.updateMatrixWorld()}}function s(e){for(var t=l.el.querySelectorAll("[doorlink]"),o=0;o<t.length;o++){var n=t[o];if(n.components.doorlink.data.from==e)return n;if(n.components.doorlink.data.to==e)return n}}var l=this,m=1e-4;l.dirty||(l.dirty=!0,setTimeout(function(){function a(e){var t=new THREE.Vector3(G,e,0);g.object3D.localToWorld(t),V.myVerts.push(t)}function c(e){var t=e.clone();re.object3D.worldToLocal(t),le.vertices.push(t)}l.el.object3D.updateMatrixWorld();for(var p=0;p<l.el.children.length;p++){var d=l.el.children[p];if(d.components&&d.components.room){var h=r(d);if(h.length>2)for(var f=0;f<h.length;f++){var g=h[f],v=h[(f+1)%h.length],u=v.components.position.data.x-g.components.position.data.x,y=v.components.position.data.z-g.components.position.data.z,E=Math.atan2(y,u);g.setAttribute("rotation",{x:0,y:-E/Math.PI*180,z:0}),g.object3D.updateMatrixWorld()}}}for(var M=l.el.querySelectorAll("[doorlink]"),w=0;w<M.length;w++){var x=M[w],A=x.components.doorlink;if(!A)return;i(A.data.from,A.el),i(A.data.to,A.el)}for(var p=0;p<l.el.children.length;p++){var d=l.el.children[p];if(d.components&&d.components.room){var R=d.components.room.data.outside,h=r(d);if(h.length>2){for(var f=0;f<h.length;f++){for(var g=h[f],v=h[(f+1)%h.length],u=v.components.position.data.x-g.components.position.data.x,y=v.components.position.data.z-g.components.position.data.z,b=Math.sqrt(u*u+y*y),E=Math.atan2(y,u),T=v.components.position.data.y-g.components.position.data.y,F=v.components.wall.data.height-g.components.wall.data.height,k=[],j=0;j<g.children.length;j++){var z=g.children[j];z.components&&z.components.doorhole&&k.push(z)}k.sort(function(e,t){return e.components.position.data.x-t.components.position.data.x});var C=new THREE.Shape;C.moveTo(0,g.components.wall.data.height),C.lineTo(0,0);for(var H=0;H<k.length;H++){var V=k[H];V.myVerts||(V.myVerts=[]),V.myVerts.length=0;var S=s(k[H]);if(S)for(var D=V.components,P=S.components,N=-1;N<=1;N+=2){var G=D.position.data.x+P.doorlink.data.width/2*N,O=G/b*T,W=O+P.doorlink.data.height,U=g.components.wall.data.height+G/b*F,B=O+U-m;W>B&&(W=B),a(O),a(W),N<0?(C.lineTo(G,O),C.lineTo(G,W)):(C.lineTo(G,W),C.lineTo(G,O))}}C.lineTo(b,v.components.position.data.y-g.components.position.data.y),C.lineTo(b,v.components.position.data.y-g.components.position.data.y+v.components.wall.data.height);var q=new THREE.ShapeGeometry(C);o(q,"x","y",1,1),n(q);var L=g.components.material?g.components.material.material:g.parentNode.components.material.material;g.myMesh?(g.myMesh.geometry=q,g.myMesh.material=L):(g.myMesh=new THREE.Mesh(q,L),g.setObject3D("wallMesh",g.myMesh))}for(var I=[],J=0;J<d.children.length;J++){var K=d.children[J];K.components&&(K.components.floor||K.components.ceiling)&&I.push(K)}for(var Q=0;Q<I.length;Q++){for(var X=I[Q],Y=X.components.ceiling,Z=new THREE.Shape,f=0;f<h.length;f++){var g=h[f],G=g.components.position.data.x,$=g.components.position.data.z;f?Z.lineTo(G,$):Z.moveTo(G,$)}for(var _=new THREE.ShapeGeometry(Z),f=0;f<h.length;f++){var g=h[f],ee=_.vertices[f];ee.set(ee.x,g.components.position.data.y,ee.y),Y&&(ee.y+=g.components.wall.data.height)}var te=!1;Y||(te=!te),R&&(te=!te),te&&e(_),o(_,"x","z",Y?1:-1,1),n(_),X.myMeshes||(X.myMeshes=[]);var oe=Y?"ceiling":"floor",L=X.components.material?X.components.material.material:X.parentNode.components.material.material;X.myMeshes[oe]?(X.myMeshes[oe].geometry=_,X.myMeshes[oe].material=L):(X.myMeshes[oe]=new THREE.Mesh(_,L),X.setObject3D(oe,X.myMeshes[oe]))}}}}for(var w=0;w<M.length;w++){var x=M[w],A=x.components.doorlink;if(A.data.from&&A.data.to){if(!A.data.from.myVerts)return;if(!A.data.to.myVerts)return;for(var ne=0;ne<x.children.length;ne++){var re=x.children[ne];if(re.components)for(var ae=["sides","floor","ceiling"],ie=0;ie<ae.length;ie++){var se=ae[ie];if(re.components[se]){var L=re.components.material?re.components.material.material:re.parentNode.components.material.material;if(re.myGeoms||(re.myGeoms=[]),!re.myGeoms[se]){var le=new THREE.Geometry;re.myGeoms[se]=le;var me=new THREE.Mesh(le,L);le.meshRef=me,re.setObject3D(se,me),le.faces.push(new THREE.Face3(0,1,2),new THREE.Face3(1,3,2)),"sides"==se&&le.faces.push(new THREE.Face3(4,5,6),new THREE.Face3(5,7,6))}var le=re.myGeoms[se];le.meshRef.material=L,le.vertices.length=0;var ce=A.data.from.myVerts,pe=A.data.to.myVerts;switch(se){case"floor":c(pe[0]),c(pe[2]),c(ce[2]),c(ce[0]),t(le,function(e,t,o){t.set(1-o%2,1-Math.floor(o/2))});break;case"ceiling":c(pe[3]),c(pe[1]),c(ce[1]),c(ce[3]),t(le,function(e,t,o){t.set(o%2,1-Math.floor(o/2))});break;case"sides":c(pe[2]),c(pe[3]),c(ce[0]),c(ce[1]),c(ce[2]),c(ce[3]),c(pe[0]),c(pe[1]),t(le,function(e,t,o){t.set(Math.floor(o/2),o%2),o<4&&(t.x=1-t.x)})}le.verticesNeedUpdate=!0,le.elementsNeedUpdate=!0,n(le)}}}}}l.dirty=!1}))}});var s={init:r,update:a,remove:i};AFRAME.registerComponent("room",Object.assign({schema:{outside:{type:"boolean"}}},s)),AFRAME.registerComponent("wall",Object.assign({schema:{height:{type:"number",default:2.4}}},s)),AFRAME.registerComponent("floor",s),AFRAME.registerComponent("ceiling",s),AFRAME.registerComponent("doorhole",s),AFRAME.registerComponent("doorlink",Object.assign({schema:{from:{type:"selector"},to:{type:"selector"},height:{type:"number",default:2},width:{type:"number",default:.8}}},s)),AFRAME.registerComponent("sides",s),AFRAME.registerPrimitive("rw-room",{defaultComponents:{room:{}},mappings:{outside:"room.outside"}}),AFRAME.registerPrimitive("rw-wall",{defaultComponents:{wall:{}},mappings:{height:"wall.height"}}),AFRAME.registerPrimitive("rw-floor",{defaultComponents:{floor:{}},mappings:{}}),AFRAME.registerPrimitive("rw-ceiling",{defaultComponents:{ceiling:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorhole",{defaultComponents:{doorhole:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorlink",{defaultComponents:{doorlink:{}},mappings:{from:"doorlink.from",to:"doorlink.to",height:"doorlink.height",width:"doorlink.width"}}),AFRAME.registerPrimitive("rw-sides",{defaultComponents:{sides:{}},mappings:{}})}]);